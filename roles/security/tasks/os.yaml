  - name: Change the password of the user pi
    user:
      name: pi
      password: "{{ pi_custom_password }}"
      state: present
      update_password: always

  - name: Create alternative user
    user:
      name: "{{ alternative_user }}"
      group: users
      groups: ['users', 'sudo']
      uid: 5000
      password: "{{ alternative_user_password }}"
      state: present
      update_password: always
      shell: /bin/bash

  - name: Set users that are allowed to use SSH
    lineinfile:
      path: "{{ sshd_config_path }}"
      insertafter: "EOF"
      line: "AllowUsers {{ alternative_user }}"

  - name: Set users that are not allowed to use SSH
    lineinfile:
      path: "{{ sshd_config_path }}"
      insertafter: "EOF"
      line: "DenyUsers pi root"

  - name: Make sudo require a password for the pi user
    lineinfile:
      path: "{{ pi_sudoersd_path }}"
      regexp: "^pi"
      line: "pi ALL=(ALL) PASSWD: ALL"

  - name: "Disable unnecessary services"
    systemd:
      name: "{{ item }}"
      enabled: no
      masked: yes
    with_items:
      - avahi-daemon
      - triggerhappy

  - name: "Reduce GPU memory to {{ gpu_memory }}mb"
    lineinfile:
      path: "{{ boot_config_path }}"
      regexp: "^gpu_mem"
      insertafter: "EOF"
      line: "gpu_mem={{ gpu_memory }}"

  - name: "Bluetooth activated: {{ enable_bluetooth }}"
    lineinfile:
      state: "{{ (enable_bluetooth != 'yes') | ternary('present', 'absent') }}"
      path: "{{ boot_config_path }}"
      regexp: "^dtoverlay=disable-bt"
      insertafter: "EOF"
      line: "dtoverlay=disable-bt"

  - name: "Bluetooth service activated: {{ enable_bluetooth }}"
    systemd:
      name: "{{ item }}"
      enabled: "{{ (enable_bluetooth == 'yes') | ternary('yes', 'no') }}"
      masked: "{{ (enable_bluetooth == 'yes') | ternary('no', 'yes') }}"
    with_items:
      - bluetooth
      - hciuart

  - name: "Wifi activated: {{ enable_wifi }}"
    lineinfile:
      state: "{{ (enable_wifi != 'yes') | ternary('present', 'absent') }}"
      path: "{{ boot_config_path }}"
      regexp: "^dtoverlay=disable-wifi"
      insertafter: "EOF"
      line: "dtoverlay=disable-wifi"

  - name: "WPA supplicant service activated: {{ enable_wifi }}"
    systemd:
      name: "{{ item }}"
      enabled: "{{ (enable_wifi == 'yes') | ternary('yes', 'no') }}"
      masked: "{{ (enable_wifi == 'yes') | ternary('no', 'yes') }}"
    with_items:
      - wpa_supplicant
